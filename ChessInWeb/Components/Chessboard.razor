<div class="chessboard" disabled="@isDisabled">
    <div class="squares">
    @for (int i = 63; i >= 0; i--)
    {
        int s = i - j;
        <Square @bind-Rerender="@rerenderCount" IconSrc="@IconSrc(s)" IdNum="@s" Selected="@availableSquares.Contains(s)" HandleClick="@ManageClick"></Square>
        j -= 2;
        if (j < -7)
        {
            j = 7;
        }
    }
    </div>
    <Informer WhiteSided=true TimeRanOut="@TimeRanOut" @bind-Message="informerMessage" @ref=informer></Informer>
</div>
@code {
    [Parameter]
    public GameManager? GameManager { get; set; }
    private string informerMessage = "Message from chessboard";
    private int rerenderCount = 0;
    private HashSet<int> availableSquares = new();
    private int currentSelected = -1;
    private int j = 7;
    private bool isDisabled = false;
    private Informer informer;
    protected override async Task OnInitializedAsync()
    {
        GameManager?.GetMoves();
        informerMessage = GameManager?.ReturnGameState();
    }
    private string resources = "Icons/";
    private string IconSrc(int square)
    {
        string respond = "";
        switch (Piece.PieceType(GameManager.Squares[square]))
        {
            case 1:
                respond = "king";
                break;
            case 2:
                respond = "pawn";
                break;
            case 3:
                respond = "knight";
                break;
            case 5:
                respond = "bishop";
                break;
            case 6:
                respond = "rook";
                break;
            case 7:
                respond = "queen";
                break;
            default:
                return "";
        }
        string color = Piece.Colour(GameManager.Squares[square]) == 8 ? "white" : "black";
        return resources + color + respond + ".png";
    }
    public void ManageClick(int id)
    {
        if (availableSquares.Contains(id))
        {
            GameManager.MakeMove(GameManager.MovesStorage[currentSelected].Where(x => x.EndIndex == id).First());
            CheckGameFinished();
            ClearMeta();
            GameManager.GetMoves();
            StateHasChanged();
            informer.SwitchTimer();
            informerMessage = GameManager.ReturnGameState();
            return;
        }
        ClearMeta();
        if (GameManager.Squares[id] != Piece.None && GameManager.MovesStorage.ContainsKey(id))
        {
            currentSelected = id;
            GameManager.MovesStorage[id].Select(x => x.EndIndex).ToList().ForEach(x => availableSquares.Add(x));
            StateHasChanged();
            return;
        }
    }
    private void ClearMeta()
    {
        rerenderCount++;
        currentSelected = -1;
        availableSquares.Clear();
    }
    private void CheckGameFinished()
    {

    }
    public void TimeRanOut(bool white)
    {
        isDisabled = true;
        informer.StopTimers();
    }
}
